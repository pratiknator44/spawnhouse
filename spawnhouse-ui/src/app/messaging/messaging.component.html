<h5 class="text-center p-2">Messages</h5>

<h3 class="text-secondary text-center mt-3" *ngIf="chats.length === 0">You have no messages
    <h5 class="text-black mt-3">Goto a user's profile and click <span class="iconset icon-bubbles3"></span> Message</h5>
</h3>

<button class="btn btn-primary" (click)="sendSocketMessage()">Send Socket MEssage</button>

<div class="w-100 row" style="overflow: hidden !important; max-height: calc( 100vh - 6rem);" *ngIf="chats.length > 0">
    <div class="col-3 std-box-shadow"  [perfectScrollbar]="{suppressScrollX: true}" style="overflow: auto; max-height: 87vh;">

        <div class="text-center text-primary mb-3 hover-underline cursor-pointer">New Message</div>

        <div class="text-center" *ngIf="messageFlags.convosLoading">
            <loader2 [type]="0"></loader2>
            <br>
            Loading Conversations
        </div>

        <div class="font-italic text-secondary text-center" *ngIf="chats.length ===0">no conversations</div>
        <div class="message-user d-flex cursor-pointer hover-bg-grey" [perfectScrollbar]="{suppressScrollX: true}" [ngClass]="{'selected-chat text-white std-box-shadow position-relative': selectedChat === chat.id, ' hover-bg': selectedChat !== chat.id}" *ngFor="let chat of chats; let i = index" (click)="selectedChat = chat.id; getMessagesFromId(chat.id); convoIndex = i;">
            <img class="dp-big circle m-2" [src]="dpLinks[i] | async" *ngIf="dpLinks[i] | async" />
            <div class="dp-big bg-grey text-black circle m-2" *ngIf="!(dpLinks[i] | async)"> <div class="iconset icon-player h2 ml-3 mt-2" style="transform: translate(-45deg);"></div></div>
            <div class="mt-2">{{chat?.username | async}}
                <div class="font-italic mt-1" style="font-size: 0.75rem;" [ngClass]="{'text-white': selectedChat === chat.id}">{{chat.text | slice: 0 : 40}} ...</div>
            </div>
            <div class="font-italic mt-2 text-right position-absolute text-grey" style="right: 1rem;">{{chat.time | ago}}</div>
        </div>

    </div>
    <div class="col-7 position-relative">
        <div class="message-area w-100 position-relative" [perfectScrollbar]="{suppressScrollX: false}" style="overflow: auto; height: calc(100vh - 11rem);" #messageArea>

            <div class="message rounded" *ngFor="let msg of conversation" [ngClass]="{'user-bubble': msg.sender == user._id, 'other-user-bubble': msg.sender != user._id}">
                    <div class="mt-3 ml-3 mr-3 mb-0 rounded">
                    {{msg.text}}
                        <div class="text-secondary ml-auto text-small">{{msg.time | date: 'HH:mm dd MMM, yyyy'}}</div>
                    </div>
                    <div class="bg-white text-small" [ngClass]="{'text-success': msg.sender == user._id, 'text-secondary': msg.sender != user._id}"><span class="iconset icon-checkmark" *ngIf="msg.seen"></span></div>
            </div>

            <div class="text-center ml-auto mr-auto" style="transform: translate(0, 50%);" *ngIf="messageFlags.msgLoading">
                <loader2 [type]="0"></loader2>
                <br>
                Refreshing Conversation
            </div>

        </div>
        <div class="send-message-area w-100 d-flex bg-lite mt-2 d-block" style="border-top: solid 1px #CCC;">
            <input type="text" [(ngModel)]="message" class="overflow-none m-2 border-none form form-control circle mt-1" placeholder="Send a message..." />
            <div class="text-white text-center cursor-pointer" style="margin-left:2.5%; margin-top: 1%;" (click)="sendMessage()"><div class="iconset icon-paper-plane mt-2" style=" color: rgb(122, 122, 78);"></div></div>
        </div>
    </div>

    <div class="col-2 bg-white std-box-shadow">

        <div class="circle dp-xl bg-lite ml-auto mr-auto text-center" (click)="routeToProfile()">
            <span class="iconset icon-player" style="font-size: 4rem;" *ngIf="!(dpLinks[convoIndex] | async)"></span>
            <img [src]="(dpLinks[convoIndex] | async)" alt="" class="h-100 w-100 circle" *ngIf="(dpLinks[convoIndex] | async)">
        </div>

        <h3 class="text-secondary text-center hover-underline cursor-pointer" (click)="routeToProfile()">{{ otherUser?.username | async }}</h3>
        <div *ngIf="otherUser?.nowplaying">
            <h6 class="text-secondary m-0 p-0">Playing</h6>
            {{ otherUser?.nowplaying.game }}
            <h6 class="text-secondary mt-3">Likes</h6>
            <span class="badge badge-info ml-1" *ngFor="let genre of otherUser?.gamedata?.genres">
                {{ genre | gameGenre }}
            </span>
        </div>


        <div class="convo-options mt-3 position-absolute text-center w-100 text-secondary3" style="bottom: 3rem;">
            <!-- This conversation: <br> -->
            <!-- <div class="badge text-secondary hover-underline cursor-pointer" (click)="convoOptions('clear')"><span class="iconset icon-cross ml-auto mr-auto"></span>&nbsp; Clear</div> -->
            <div class="badge text-danger hover-underline cursor-pointer" (click)="convoOptions('delete')"><span class="iconset icon-bin ml-auto mr-auto"></span>&nbsp; Delete this conversation</div>

        </div>
        
    </div>
</div>